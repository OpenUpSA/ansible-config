---
- hosts: dokkus
  remote_user: ubuntu
  become: yes
  become_method: sudo
  pre_tasks:
    - name: Set the timezone for the server to be UTC
      command: file state=link /usr/share/zoneinfo/UTC /etc/localtime
    - name: Set up a unique hostname
      hostname: name={{ inventory_hostname }}
    - name: Set up unattended-upgrades
      apt:
        update_cache: yes
        name: unattended-upgrades
        state: present
    - name: Generate SSH keys
      shell: ssh-keygen -b 2048 -t rsa -f /root/.ssh/id_rsa -q -N ""
      args:
        creates: /root/.ssh/id_rsa
  roles:
   - role: dokku_bot.ansible_dokku
     vars:
       dokku_users:
       - name: {{ item }}
         username: {{ item }}
         ssh_key: "{{ lookup('file', 'files/'+ item + '.key.pub') }}"
      with_items: "{{ all_hosts_admins + host_extra_admins }}"
  tasks:
    - "Default packages are installed"
      apt:
        pkg:
        - emacs-nox
        - htop
        - screen
