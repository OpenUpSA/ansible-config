---
- hosts:
    - idp-data
  become: yes
  roles:
   - dokku_bot.ansible_dokku


  vars:
    app_name: idp-data
    app_domain: idp-data.openup.org.za
    dokku_daemon_install: false # We install this using a dedicated playbook
    dokku_plugins:
      - name: letsencrypt
        url: https://github.com/dokku/dokku-letsencrypt.git
    postgres_database: idp
    postgres_hostname: postgresql11-prod.cnc362bhpvfe.eu-west-1.rds.amazonaws.com
    postgres_user: "{{ lookup('passwordstore', 'apps/idp/prod/POSTGRES subkey=username')}}"
    postgres_password: "{{ lookup('passwordstore', 'apps/idp/prod/POSTGRES')}}"

  tasks:

    - name: "Dokku app exists"
      dokku_app:
        app: "{{ app_name }}"

    - name: "Dokku app config is set"
      dokku_config:
        app: "{{ app_name }}"
        config:
          DOKKU_LETSENCRYPT_EMAIL: 'webapps@openup.org.za'
          SENTRY_DSN: https://d9789f84b574455f8183eeb846b577f9@o242378.ingest.sentry.io/5357359
          DATABASE_URL: 'postgresql://{{ postgres_user }}:{{ postgres_password }}@{{ postgres_hostname }}:5432/{{ postgres_database }}'
          DJANGO_SECRET_KEY: "{{ lookup('passwordstore', 'apps/idp/prod/DJANGO_SECRET_KEY') }}"

    - name: "Dokku app domains are configured"
      dokku_domains:
        app: "{{ app_name }}"
        domains:
          - "{{ app_domain }}"

    - name: "Your dokku git remote"
      debug:
        msg: "dokku@{{ inventory_hostname }}:{{ app_name }}"

    - name: Nginx is reloaded
      service:
        name: nginx
        state: reloaded
      when: nginx.changed
