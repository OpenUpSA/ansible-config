---
- hosts:
    - pmg1-aws.pmg.org.za
  become: yes
  roles:
   - dokku_bot.ansible_dokku
   - ansible-modules-bitwarden


  vars:
    app_name: pmg
    app_domain: pmg.org.za
    dokku_daemon_install: false # We install this using a dedicated playbook
    dokku_plugins:
      - name: letsencrypt
        url: https://github.com/dokku/dokku-letsencrypt.git
    postgres_database: pmg
    postgres_hostname: postgresql1.ctribismbyc2.eu-west-1.rds.amazonaws.com
    postgres_user: "{{ lookup('bitwarden', 'POSTGRES', collection='project/pmg/' ~ env_name, field='fields.username')}}"
    postgres_password: "{{ lookup('bitwarden', 'POSTGRES', collection='project/pmg/' ~ env_name, ')}}"
    # postgres_password: "{{ lookup('bitwarden', 'POSTGRES', collection='project/municipal-money/' ~ env_name, field='fields.password')}}"

  tasks:

    - name: "Dokku app exists"
      dokku_app:
        app: "{{ app_name }}"
      tags:
        - app

    - name: "Dokku app config is set"
      dokku_config:
        app: "{{ app_name }}"
        config:
          AWS_ACCESS_KEY_ID: "{{ lookup('bitwarden', 'AWS', collection='project/pmg/' ~ env_name,  field='fields.ACCESS_KEY_ID') }}"
          AWS_SECRET_ACCESS_KEY: "{{ lookup('bitwarden', 'AWS', collection='project/pmg/' ~ env_name, field='fields.SECRET_ACCESS_KEY') }}"
          S3_BUCKET: pmg-assets2
          DOKKU_LETSENCRYPT_EMAIL: 'webapps@openup.org.za'
          ES_SERVER: http://ec2-34-244-168-80.eu-west-1.compute.amazonaws.com:9200
          FLASK_ENV: production
          FLASK_SECRET_KEY: "{{ lookup('bitwarden', 'FLASK_SECRET_KEY', collection='project/pmg/' ~ env_name, field='fields.key') }}"
          FRONTEND_HOST: "https://{{ app_domain }}/"
          SERVER_NAME: "{{ app_domain }}"
          MAIL_SERVER: "{{ lookup('bitwarden', 'SMTP', collection='project/pmg/' ~ env_name, field='fields.server') }}"
          MAIL_USERNAME: "{{ lookup('bitwarden', 'SMTP', collection='project/pmg/' ~ env_name, field='fields.username') }}"
          MAIL_PASSWORD: "{{ lookup('bitwarden', 'SMTP', collection='project/pmg/' ~ env_name, field='fields.password') }}"
          MAIL_PORT: "{{ lookup('bitwarden', 'SMTP', collection='project/pmg/' ~ env_name, field='fields.port') }}"
          MAX_SOUNDCLOUD_BATCH: "50"
          RECAPTCHA_PRIVATE_KEY: "{{ lookup('bitwarden', 'RECAPTCHA', collection='project/pmg/' ~ env_name, field='fields.PRIVATE_KEY') }}"
          RECAPTCHA_PUBLIC_KEY: "{{ lookup('bitwarden', 'RECAPTCHA', collection='project/pmg/' ~ env_name,  field='fields.PUBLIC_KEY') }}"
          RUN_PERIODIC_TASKS: "true"
          SECURITY_PASSWORD_SALT: "{{ lookup('bitwarden', 'SECURITY_PASSWORD_SALT', collection='project/pmg/' ~ env_name, field='fields.salt') }}"
          SENDGRID_API_KEY: "{{ lookup('bitwarden', 'SENDGRID_API_KEY', collection='project/pmg/' ~ env_name, field='fields.key') }}"
          SENTRY_DSN: https://15f79f6945ff4d4f8ac103e6a9c2f26d@sentry.io/1489874
          SESSION_COOKIE_DOMAIN: "{{ app_domain }}"
          SOUNDCLOUD_APP_KEY_ID: "{{ lookup('bitwarden', 'SOUNDCLOUD_APP_KEY', collection='project/pmg/' ~ env_name,  field='fields.key_id') }}"
          SOUNDCLOUD_APP_KEY_SECRET: "{{ lookup('bitwarden', 'SOUNDCLOUD_APP_KEY', collection='project/pmg/' ~ env_name, field='fields.secret') }}"
          SOUNDCLOUD_PASSWORD: "{{ lookup('bitwarden', 'SOUNDCLOUD', collection='project/pmg/' ~ env_name, field='fields.password') }}"
          SOUNDCLOUD_PERIOD_MINUTES: "5"
          SOUNDCLOUD_USERNAME: "{{ lookup('bitwarden', 'SOUNDCLOUD', collection='project/pmg/' ~ env_name,  field='fields.username') }}"
          SQLALCHEMY_DATABASE_URI: 'postgresql://{{ postgres_user }}:{{ postgres_password }}@{{ postgres_hostname }}:5432/{{ postgres_database }}'
          STATIC_HOST: 'https://static.pmg.org.za/'
      tags:
        - app


    - name: "Dokku app domains are configured"
      dokku_domains:
        app: "{{ app_name }}"
        domains:
          - "{{ app_domain }}"
          - "www.{{ app_domain }}"
          - "api.{{ app_domain }}"
          - "bills.{{ app_domain }}"
      tags:
        - app

    - name: "Your dokku git remote"
      debug:
        msg: "dokku@{{ inventory_hostname }}:{{ app_name }}"
      tags:
        - app

    - name: "App nginx directory exists"
      file:
        path: "/home/dokku/{{ app_name }}/nginx.conf.d"
        state: directory
        mode: '0755'
        owner: dokku
        group: dokku
      tags:
        - app

    - name: Upload file size is configured
      copy:
        content: "client_max_body_size 100M;"
        dest: "/home/dokku/{{ app_name }}/nginx.conf.d/client_max_body_size.conf"
        owner: dokku
        group: dokku
        mode: "0644"
      register: nginx
      tags:
        - app

    - name: Nginx is reloaded
      service:
        name: nginx
        state: reloaded
      when: nginx.changed
      tags:
        - app
