---
- hosts:
    - treasury3.openup.org.za
  vars:
    app_name: vulekamali-ckan-sandbox
    app_domain: sandbox-data.vulekamali.gov.za
    postgres_hostname: prod-db.vulekamali.gov.za
    postgres_superuser_user: "{{ lookup('passwordstore', 'core/vulekamali/POSTGRES_SUPERUSER subkey=username')}}"
    postgres_superuser_password: "{{ lookup('passwordstore', 'core/vulekamali/POSTGRES_SUPERUSER')}}"
    ckan_datastore_database: datastore_default_sandbox
    ckan_datastore_postgres_read_user: "{{ lookup('passwordstore', 'apps/vulekamali/ckan/sandbox/CKAN_DATASTORE_POSTGRES_READ subkey=username')}}"
    ckan_datastore_postgres_read_password: "{{ lookup('passwordstore', 'apps/vulekamali/ckan/sandbox/CKAN_DATASTORE_POSTGRES_READ')}}"
    ckan_datastore_postgres_write_user: "{{ lookup('passwordstore', 'apps/vulekamali/ckan/sandbox/CKAN_DATASTORE_POSTGRES_WRITE subkey=username')}}"
    ckan_datastore_postgres_write_password: "{{ lookup('passwordstore', 'apps/vulekamali/ckan/sandbox/CKAN_DATASTORE_POSTGRES_WRITE')}}"
    ckan_postgres_database: ckan_default_sandbox
    ckan_postgres_user: "{{ lookup('passwordstore', 'apps/vulekamali/ckan/sandbox/CKAN_POSTGRES subkey=username')}}"
    ckan_postgres_password: "{{ lookup('passwordstore', 'apps/vulekamali/ckan/sandbox/CKAN_POSTGRES')}}"
  tasks:
    - name: dokku-redis plugin installed
      dokku_plugins:
        - name: redis
          url: https://github.com/dokku/dokku-redis.git

    - name: "Redis instance {{ app_name }} exists"
      dokku_service_create:
        name: "{{ app_name }}"
        service: redis

    - name: Database "{{ ckan_datastore_database }}" exists
      postgresql_db:
        name: "{{ ckan_datastore_database }}"

    - name: "Database user {{ ckan_datastore_postgres_read_user }} exists"
      postgresql_user:
        ssl_mode: verify-full
        login_user: "{{ postgres_superuser_user }}"
        login_password: "{{ postgres_superuser_password }}"
        login_host: "{{ postgres_hostname }}"
        db: "{{ ckan_datastore_database }}"
        name: "{{ ckan_datastore_postgres_read_user }}"
        password: "{{ ckan_datastore_postgres_read_password }}"
        priv: "CONNECT/{{ ckan_datastore_database }}:ALL"
        state: present

    - name: "Dokku app {{ app_name }} exists"
      dokku_app:
        app: "{{ app_name }}"

    - name: "Domain {{ app_domain }} proxied to dokku app {{ app_name }}"
      dokku_domains:
        app: "{{ app_name }}"
        domains:
          - "{{ app_domain }}"

    - name: "Dokku app {{ app_name }} config is set"
      dokku_config:
        app: "{{ app_name }}"
        config:
          CKAN___BEAKER__SESSION__SECRET: "{{ lookup('passwordstore', 'apps/vulekamali/ckan/sandbox/BEAKER_SESSION_SECRET')}}"
          CKAN___CKANEXT__S3FILESTORE__AWS_ACCESS_KEY_ID: "{{ lookup('passwordstore', 'apps/vulekamali/ckan/sandbox/AWS subkey=ACCESS_KEY_ID')}}"
          CKAN___CKANEXT__S3FILESTORE__AWS_SECRET_ACCESS_KEY: "{{ lookup('passwordstore', 'apps/vulekamali/ckan/sandbox/AWS')}}"
          CKAN___CKANEXT__S3FILESTORE__AWS_BUCKET_NAME: 'vulekamali-datastore-sandbox'
          CKAN___CKANEXT__S3FILESTORE__HOST_NAME: 'http://s3-eu-west-1.amazonaws.com/vulekamali-datastore-sandbox'
          CKAN___CKANEXT__S3FILESTORE__REGION_NAME: 'eu-west-1'
          CKAN___CKANEXT__S3FILESTORE__SIGNATURE_VERSION: 's3v4'
          CKAN_DATASTORE_READ_URL: 'postgres://{{ ckan_datastore_postgres_read_user }}:{{ ckan_datastore_postgres_read_password }}@{{ postgres_hostname }}:5432/{{ ckan_datastore_database }}'
          CKAN_DATASTORE_WRITE_URL: 'postgres://{{ ckan_datastore_postgres_write_user }}:{{ ckan_datastore_postgres_write_password }}@{{ postgres_hostname }}:5432/{{ ckan_datastore_database }}'
          CKAN_SQLALCHEMY_URL: 'postgresql://{{ ckan_postgres_user }}:{{ ckan_postgres_password }}@{{ postgres_hostname }}:5432/{{ ckan_postgres_database }}'
          CKAN_INI: '/ckan.ini'
          CKAN_SITE_URL: 'https://{{ app_domain }}/'
          CKAN_SMTP_MAIL_FROM: 'info@vulekamali.gov.za'
          CKAN_SMTP_PASSWORD: "{{ lookup('passwordstore', 'apps/vulekamali/ckan/sandbox/SMTP')}}"
          CKAN_SMTP_SERVER: "{{ lookup('passwordstore', 'apps/vulekamali/ckan/sandbox/SMTP subkey=hostname')}}"
          CKAN_SMTP_USER: "{{ lookup('passwordstore', 'apps/vulekamali/ckan/sandbox/SMTP subkey=username')}}"
          CKAN_SOLR_URL: 'http://solr.vulekamali.gov.za:8983/solr/ckan-sandbox'
          CKAN_SSO_LOGOUT_URL: 'https://sandbox.vulekamali.gov.za/accounts/logout'
          CKAN_SSO_SECRET: "{{ lookup('passwordstore', 'apps/vulekamali/ckan/sandbox/SSO_SECRET')}}"
          CKAN_SSO_URL: 'https://sandbox.vulekamali.gov.za/ckan/sso'
          DOKKU_LETSENCRYPT_EMAIL: 'webapps+treasury@openup.org.za'

    - name: HTTP cache configured

    - name: "Redis instance {{ app_name }} linked to dokku app {{ app_name }}"
      dokku_service_link:
        app: "{{ app_name }}"
        name: "{{ app_name }}"
        service: redis

    - name: App code installed
    - name: Database initialised
    - name: TLS certificate created
    - name: TLS certificate autorenewal set up
    - name: Uptime monitoring configured to check site is running
