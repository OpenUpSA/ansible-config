---


- hosts:
    - treasury3.openup.org.za
  become: yes
  become_method: sudo


  roles:
   - dokku_bot.ansible_dokku

  vars:
    app_name: vulekamali-budgetportal-sandbox
    app_domain: sandbox-data.vulekamali.gov.za
    postgres_hostname: prod-db.vulekamali.gov.za
    postgres_superuser_user: "{{ lookup('passwordstore', 'core/vulekamali/POSTGRES_SUPERUSER subkey=username')}}"
    postgres_superuser_password: "{{ lookup('passwordstore', 'core/vulekamali/POSTGRES_SUPERUSER')}}"
    postgres_database: budgetportal_sandbox
    postgres_user: "{{ lookup('passwordstore', 'apps/vulekamali/budgetportal/sandbox/POSTGRES subkey=username')}}"
    postgres_password: "{{ lookup('passwordstore', 'apps/vulekamali/budgetportal/sandbox/POSTGRES')}}"

  tasks:

    - name: Install postgres client for managing databases
      apt: name={{ item }} state=present
      with_items:
        - libpq-dev
        - python3-psycopg2

    - name: "Database {{ postgres_database }} exists"
      postgresql_db:
        ssl_mode: require
        login_user: "{{ postgres_superuser_user }}"
        login_password: "{{ postgres_superuser_password }}"
        login_host: "{{ postgres_hostname }}"
        name: "{{ postgres_database }}"

    - name: "Database user {{ postgres_user }} exists"
      postgresql_user:
        ssl_mode: require
        login_user: "{{ postgres_superuser_user }}"
        login_password: "{{ postgres_superuser_password }}"
        login_host: "{{ postgres_hostname }}"
        db: "{{ postgres_database }}"
        name: "{{ postgres_user }}"
        password: "{{ postgres_password }}"
        priv: "ALL"
        state: present

    - name: "Dokku app {{ app_name }} exists"
      dokku_app:
        app: "{{ app_name }}"

    - name: "Dokku app {{ app_name }} config is set"
      dokku_config:
        app: "{{ app_name }}"
        config:
          DJANGO_DEBUG: "false"
          DISABLE_COLLECTSTATIC: "1"
          DJANGO_SECRET_KEY: "{{ lookup('passwordstore', 'apps/vulekamali/budgetportal/sandbox/DJANGO_SECRET_KEY')}}"
          CKAN_API_KEY: "{{ lookup('passwordstore', 'apps/vulekamali/budgetportal/sandbox/CKAN_USER', subkey='api-key')}}"
          CKAN_URL: "https://sandbox-data.vulekamali.gov.za"
          DATABASE_URL: "postgresql://{{ postgres_user }}:{{ postgres_password }}@{{ postgres_hostname }}:5432/{{ postgres_database }}"
          EMAIL_HOST_PASSWORD: "{{ lookup('passwordstore', 'apps/vulekamali/budgetportal/sandbox/SMTP')}}"
          DISCOURSE_SSO_SECRET: "{{ lookup('passwordstore', 'apps/vulekamali/budgetportal/sandbox/SSO_SECRET')}}"
          RECAPTCHA_PRIVATE_KEY: "{{ lookup('passwordstore', 'apps/vulekamali/budgetportal/sandbox/RECAPTCHA')}}"
          SENTRY_DSN: "https://acd93673a56a48939bef31fc9ad92f2c@sentry.io/1888207"
          DOKKU_LETSENCRYPT_EMAIL: 'webapps+treasury@openup.org.za'
          AWS_ACCESS_KEY_ID: "{{ lookup('passwordstore', 'apps/vulekamali/ckan/sandbox/AWS subkey=ACCESS_KEY_ID')}}"
          AWS_SECRET_ACCESS_KEY: "{{ lookup('passwordstore', 'apps/vulekamali/ckan/sandbox/AWS')}}"
          AWS_STORAGE_BUCKET_NAME: "sandbox-media.vulekamali.gov.za"
          SOLR_URL: "https://solr.vulekamali.gov.za:8983/solr/budetportal-sandbox"
          CKAN_SSO_URL: "https://sandbox-data.vulekamali.gov.za/user/login"
          ACCOUNT_LOGOUT_REDIRECT_URL: "https://sandbox.vulekamali.gov.za/"
